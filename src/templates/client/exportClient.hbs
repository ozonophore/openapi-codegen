{{>header}}

import { OpenAPI } from '{{{joinPath @root.outputCore 'OpenAPI'}}}';
import type { TOpenAPIConfig } from '{{{joinPath @root.outputCore 'OpenAPI'}}}';
import { createExecutorAdapter } from '{{{joinPath @root.outputCore './executor/createExecutorAdapter'}}}';
import { RequestInterceptor, ResponseInterceptor, ErrorInterceptor } from '{{{joinPath @root.outputCore './interceptors/interceptors'}}}';
import { withInterceptors } from '{{{joinPath @root.outputCore './interceptors/withInterceptors'}}}';
import { apiErrorInterceptor } from '{{{joinPath @root.outputCore './interceptors/apiErrorInterceptor'}}}';

{{#each services}}
import { {{name}} } from './services/{{name}}';
{{/each}}

export interface ClientOptions {
  openApi?: Partial<TOpenAPIConfig>;
  interceptors?: {
    onRequest?: RequestInterceptor[];
    onResponse?: ResponseInterceptor[];
    onError?: ErrorInterceptor[];
  }
}

export function createClient<TExecutorOptions extends Record<string, any>>(
  options: ClientOptions = {},
) {
  const openApiConfig: TOpenAPIConfig = {
    ...OpenAPI,
    ...options.openApi,
  };

  let executor = createExecutorAdapter<TExecutorOptions>(openApiConfig);
  if (options?.interceptors) {
    executor = withInterceptors(executor, {
      onError: [apiErrorInterceptor, ...(options.interceptors?.onError ?? [])],
      onRequest: options.interceptors?.onRequest,
      onResponse: options.interceptors?.onResponse,
    });
  }

  return {
    {{#each services}}
    {{camelCase name}}: new {{name}}(executor),
    {{/each}}
  };
}
