{{>header}}

import type { RequestExecutor, RequestConfig } from './request-executor';
import type { ApiRequestOptions } from './ApiRequestOptions';
import type { TOpenAPIConfig } from './OpenAPI';
import { OpenAPI } from './OpenAPI';
import { request as __request } from './request';

/**
 * Legacy RequestExecutor-адаптер поверх существующего request(ApiRequestOptions, OpenAPI).
 *
 * TOptions — тип рантайм-опций транспорта (IXHROptions, IFetchOptions и т.п.).
 * mapOptions — опциональная функция, которая мапит TOptions → часть ApiRequestOptions.
 */
export function createLegacyExecutor<TOptions = unknown>(
    openApiConfig: TOpenAPIConfig = OpenAPI,
    mapOptions?: (options: TOptions | undefined) => Partial<ApiRequestOptions>,
): RequestExecutor<TOptions> {
    return {
        request<TResponse>(config: RequestConfig, options?: TOptions): Promise<TResponse> {
            const baseOptions: ApiRequestOptions = {
                method: config.method as ApiRequestOptions['method'],
                path: config.url,         // RequestConfig.url → ApiRequestOptions.path
                headers: config.headers,
                query: config.query,
                body: config.body,
            };

            const mergedOptions: ApiRequestOptions = {
                ...baseOptions,
                ...(mapOptions ? mapOptions(options) : {}),
            };

            return __request<TResponse>(mergedOptions, openApiConfig);
        },
    };
}